<!doctype html>
<html>
  <head>
    <title>Find My Sound</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"/>   
    <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="styles/style.css"/>
  </head>

  <body> 
    <div class="container">
      <div id="login">
        <h1>Find My Sound!</h1>
        <img id="fms-preview" alt="FindMySound preview 1" src="https://i.imgur.com/MDASvJp.png"></img>
        <img id="fms-preview" alt="FindMySound preview 2" src="https://i.imgur.com/BodYNWZ.png"></img>
        <h2> Finding new tunes for you is all we do.</h2>
        <p>Here at FMS we consider ourselves music junkies, but we wanted to make the process of finding new artists and bands faster and easier than ever before. So we take your top artists and find artists that are the most similar to them, and show you their top songs! </p>
        <a href="/.netlify/functions/login" class="btn btn-primary">Log in with Spotify</a>
      </div>
      <div id="loggedin">
        <div id="user-profile"></div>
        <div id="recommendations">
          <h2>Your Recommendations</h2>
          <ul id="rec-list"></ul>
        </div>
        <div id="oauth"></div>
        <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
      </div>
    </div>

    <script id="user-profile-template" type="text/x-handlebars-template">
      <h1>Howdy there pardner {{display_name}}</h1>
      <div class="media">
        <div class="pull-left">
          <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
          <dl class="dl-horizontal">
            <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
            <dt>Country</dt><dd>{{country}}</dd>
          </dl>
        </div>
      </div>
    </script>

    <script id="oauth-template" type="text/x-handlebars-template">
      <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
        <dt>Refresh token</dt><dd class="text-overflow">{{refresh_token}}</dd>
      </dl>
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function() {
        function getQueryParams() {
          var queryParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.search.substring(1);
          while (e = r.exec(q)) {
             queryParams[e[1]] = decodeURIComponent(e[2]);
          }
          return queryParams;
        }

        var userProfileSource = document.getElementById('user-profile-template').innerHTML,
            userProfileTemplate = Handlebars.compile(userProfileSource),
            userProfilePlaceholder = document.getElementById('user-profile');

        var oauthSource = document.getElementById('oauth-template').innerHTML,
            oauthTemplate = Handlebars.compile(oauthSource),
            oauthPlaceholder = document.getElementById('oauth');

        var params = getQueryParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            // Render oauth info
            oauthPlaceholder.innerHTML = oauthTemplate({
              access_token: access_token,
              refresh_token: refresh_token
            });

            // Fetch user profile
            $.ajax({
              url: 'https://api.spotify.com/v1/me',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                $('#login').hide();
                $('#loggedin').show();
              }
            });

            // Fetch recommendations
            $.ajax({
              url: '/.netlify/functions/recommendations',
              headers: {
                'Authorization': 'Bearer ' + access_token
              },
              success: function(response) {
                const recList = document.getElementById('rec-list');
                response.recList.forEach(artist => {
                  const li = document.createElement('li');
                  li.textContent = artist.name;
                  recList.appendChild(li);
                });
              }
            });
          } else {
            // Render initial screen
            $('#login').show();
            $('#loggedin').hide();
          }

          document.getElementById('obtain-new-token').addEventListener('click', function() {
            $.ajax({
              url: '/.netlify/functions/refresh_token',
              data: {
                'refresh_token': refresh_token
              }
            }).done(function(data) {
              access_token = data.access_token;
              oauthPlaceholder.innerHTML = oauthTemplate({
                access_token: access_token,
                refresh_token: refresh_token
              });
            });
          }, false);
        }
      })();
    </script>
  </body>
</html>